<!DOCTYPE html>
<html>
<head>
  <title>Number Memory Game</title>
  <style>
    #numberDisplay {
      font-size: 72px;
    }
    .input-box {
      width: 50px;
      height: 50px;
      font-size: 36px;
      text-align: center;
      margin: 5px;
      display: inline-block;
    }
  </style>
</head>
<body>

  <h1>Number Memory Game</h1>
  <p>This is a memory game. It is not secure or confidential - use at your own risk.</p>
  <p>Please put the number in backward. You will be graded based on correct backward order and other parameters.</p>
  
  <div id="numberDisplay"></div>
  <div id="userInputContainer" style="display:none;">
    <!-- Input boxes will be added here -->
  </div>
  
  <button onclick="startGame()" id="startButton">Start</button>
  <button onclick="checkAnswer()" style="display:none;" id="submitButton">Submit</button>
  
  <p>Level: <span id="level">5</span></p>
  <p>Score: <span id="score">0</span></p>
  <p>Best Score: <span id="bestScore">0</span></p>
  
  <script>

let level = 5;
let score = 0;
let bestScore = 0;
let originalNumber = "";
let startTime = null;
let totalTries = 0;
let cycleCounter = 0;
let cycleData = [];

async function startGame() {
  if (cycleCounter >= 4) {
      let confirmed = confirm("Do you want to continue as " + localStorage.getItem("email") + "?");
      if (confirmed) {
        cycleCounter = 0;
        score = 0;
        cycleData = [];
      } else {
        let newEmail = prompt("Enter a new email:");  // Changed this line
        localStorage.setItem("email", newEmail);  // And this line
        cycleCounter = 0;
        score = 0;
        cycleData = [];
      }
    } else if (cycleCounter === 0) {
   let email = prompt("Enter your email:");
   localStorage.setItem("email", email);
        
   let medication = prompt("Are you using any concentration-affecting medication? Options: coffee, alcohol, mj, wellbutrin, nothing, other");
   if (medication === "other") {
     medication = prompt("Please specify the other concentration-affecting medication:");
  }
  localStorage.setItem("medication", medication);
  document.getElementById("startButton").style.display = "none";
  totalTries++;
  originalNumber = generateUniqueNumber(level);
  for (let digit of originalNumber) {
    displayDigit(digit);
    await sleep(1000);
    clearDisplay();
  }
  displayInputBoxes(level);
  startTime = new Date().getTime();
}

function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

function generateUniqueNumber(length) {
  const digits = [...Array(10).keys()];
  let number = "";
  for (let i = 0; i < length; i++) {
    const randIndex = Math.floor(Math.random() * digits.length);
    number += digits.splice(randIndex, 1);
  }
  return number;
}

function displayDigit(digit) {
  document.getElementById("numberDisplay").innerText = digit;
}

function clearDisplay() {
  document.getElementById("numberDisplay").innerText = "";
}

function displayInputBoxes(length) {
  const container = document.getElementById("userInputContainer");
  for (let i = 0; i < length; i++) {
    const input = document.createElement("input");
    input.type = "text";
    input.className = "input-box";
    input.maxLength = 1;
    input.disabled = true;
    input.addEventListener('input', function() {
      if (this.nextSibling) {
        this.nextSibling.disabled = false;
        this.nextSibling.focus();
      }
    });
    container.appendChild(input);
    if (i === 0) {
      input.disabled = false;
    }
  }
  document.getElementById("submitButton").style.display = "block";
  document.getElementById("userInputContainer").style.display = "block";
}

function checkAnswer() {
  cycleCounter++;
  
  let elapsedTime = new Date().getTime() - startTime;
  let userNumber = "";
  document.querySelectorAll(".input-box").forEach(input => {
    userNumber += input.value;
  });

  // Reverse the original number for grading and storing as the correct answer
  let reversedOriginalNumber = originalNumber.split('').reverse().join('');

  // Store cycle information
  let cycleInfo = {
    userAnswer: userNumber,
    correctAnswer: reversedOriginalNumber,
    originalOrder: originalNumber
  };
  
  cycleData.push(cycleInfo);

  if (userNumber === reversedOriginalNumber) {
    level++;
  } else if (level > 2) {
    level--;
  }

  // Use reversedOriginalNumber for grading
  let partialScore = 0;
  for (let i = 0; i < reversedOriginalNumber.length; i++) {
    if (userNumber[i] === reversedOriginalNumber[i]) {
      partialScore += 5;
    } else if (reversedOriginalNumber.includes(userNumber[i])) {
      partialScore += 2;
    }
  }

  score += (partialScore * level) / totalTries - Math.floor(elapsedTime / 1000);

  if (score > bestScore) {
    bestScore = score;
  }

  document.getElementById("level").innerText = level;
  document.getElementById("score").innerText = Math.floor(score);
  document.getElementById("bestScore").innerText = Math.floor(bestScore);

  document.getElementById("userInputContainer").innerHTML = "";
  document.getElementById("submitButton").style.display = "none";
  document.getElementById("startButton").style.display = "block";
  
  if (cycleCounter >= 4) {
    endGame();
  } else {
    startGame();
  }
}

function endGame() {
  let email = localStorage.getItem("email");
  let timestamp = new Date().toISOString();
  
  let userData = {
    email: email,
    score: Math.floor(score),
    timestamp: timestamp
  };
  
  localStorage.setItem("userData", JSON.stringify(userData));
  
  let summary = "Game Summary:\n";
  cycleData.forEach((cycle, index) => {
    summary += `Cycle ${index + 1}:\n`;
    summary += `Your Answer: ${cycle.userAnswer}\n`;
    summary += `Correct Answer: ${cycle.correctAnswer}\n`;
    summary += `Original Order: ${cycle.originalOrder}\n`;
  });
  
  alert(summary);
}

  </script>
  
</body>
</html>
